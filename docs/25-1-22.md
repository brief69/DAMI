# 2025-01-22

## P2P通信基盤の変更

### 変更理由
- Hypercore ProtocolとIPFSのDHT実装に互換性がないことが判明
- より標準的なP2P通信基盤が必要

### 実装変更内容
1. 依存関係の更新
   - Hypercore Protocol関連パッケージを削除
   - libp2p関連パッケージを追加
     - `libp2p`: コア機能
     - `@libp2p/kad-dht`: DHT実装
     - `@libp2p/pubsub`: Pub/Sub機能
     - その他必要なトランスポート層とプロトコル

2. P2P通信の実装
   - `P2PManager`クラスの作成
   - 主な機能：
     - ノードの初期化と管理
     - トピックベースの発行/購読
     - ピア検索
     - 暗号化通信

### エンティティの更新
1. Chunkエンティティの改善
   - `size`プロパティの追加
   - `ChunkType.UNKNOWN`の追加
   - コンストラクタベースの実装に変更

2. Recipeエンティティの改善
   - `createdAt`と`updatedAt`プロパティの追加
   - `value`プロパティの追加
   - イミュータブルな更新のための`withUpdates`メソッドを追加

### IPFS操作の改善
1. ChunkManagerImplの修正
   - IPFSの操作を`cat`メソッドを使用するように変更
   - コンストラクタベースのオブジェクト生成に変更
   - 非同期データストリームの適切な処理

2. RecipeManagerImplの修正
   - イミュータブルな更新処理の実装
   - IPFSの操作を`cat`メソッドを使用するように変更
   - コンストラクタベースのオブジェクト生成に変更

### 型の問題への対応
1. libp2pの型定義の問題
   - サービスの型定義が不完全
   - pubsubインターフェースの型が未定義

2. 一時的な対処
   - カスタム`PubSubMessage`インターフェースを定義
   - `as any`型アサーションを使用
   - 将来的なlibp2pの型定義改善時に適切な型付けに更新予定

### 次のステップ
- 既存コードベースの更新✅
- テスト実装
- エラーハンドリング強化
- パフォーマンス最適化
